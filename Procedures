Procedure 1

--

DELIMITER //

DROP PROCEDURE IF EXISTS MediaPontuacaoPorUsuario //

CREATE PROCEDURE MediaPontuacaoPorUsuario()
BEGIN
    SELECT 
        u.idUsuario,
        u.apelido,
        
        COUNT(CASE WHEN ru.correta = 1 THEN 1 END) AS total_acertos,
       
        COUNT(DISTINCT r.idResultado) AS total_tentativas,
      
        IFNULL(
            ROUND(
                COUNT(CASE WHEN ru.correta = 1 THEN 1 END) / NULLIF(COUNT(DISTINCT r.idResultado), 0),
                2
            ),
            0
        ) AS media_pontuacao_por_tentativa
    FROM usuarios u
    LEFT JOIN resultado r ON u.idUsuario = r.idUsuario
    LEFT JOIN respostas_usuario ru ON r.idResultado = ru.idResultado
    GROUP BY u.idUsuario, u.apelido
    ORDER BY media_pontuacao_por_tentativa DESC;
END //

DELIMITER ;


Procedure 2

--

DELIMITER //

DROP PROCEDURE IF EXISTS EstatisticasQuestao //

CREATE PROCEDURE EstatisticasQuestao(IN p_idQuestao INT)
BEGIN
  
    SELECT
        q.idQuestao,
        q.enunciado,
      
        COUNT(ru.idResposta) AS total_respostas,
      
        COUNT(CASE WHEN ru.correta = 1 THEN 1 END) AS total_acertos,
        
        COUNT(CASE WHEN ru.correta = 0 THEN 1 END) AS total_erros,
       
        IFNULL(
            ROUND(
                (COUNT(CASE WHEN ru.correta = 1 THEN 1 END) / NULLIF(COUNT(ru.idResposta), 0)) * 100,
                2
            ),
            0
        ) AS taxa_acerto_percentual,
      
        IFNULL(
            ROUND(
                (COUNT(CASE WHEN ru.correta = 0 THEN 1 END) / NULLIF(COUNT(ru.idResposta), 0)) * 100,
                2
            ),
            0
        ) AS taxa_erro_percentual
    FROM questoes q
    LEFT JOIN respostas_usuario ru ON q.idQuestao = ru.idQuestao
    WHERE q.idQuestao = p_idQuestao
    GROUP BY q.idQuestao, q.enunciado;
END //

DELIMITER ;
